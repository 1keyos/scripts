#!/bin/bash

# Copyright (c) 2011 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

echo "Applying patch to init scripts."

touch "${ROOT_FS_DIR}/root/.factory_test"
touch "${ROOT_FS_DIR}/root/.leave_firmware_alone"

patch -d "${ROOT_FS_DIR}" -Np1 <<EOF
--- old/etc/init/ui.conf	2010-04-28 21:28:38.886069000 -0700
+++ new/etc/init/ui.conf	2010-04-28 21:29:42.676163000 -0700
@@ -11 +11 @@
-start on stopping startup
+start on never
EOF

patch -d "${ROOT_FS_DIR}" -Np1 <<EOF
diff -Naur old/etc/init/boot-complete.conf new/etc/init/boot-complete.conf
--- old/etc/init/boot-complete.conf	2010-07-21 11:22:30.000000000 +0800
+++ new/etc/init/boot-complete.conf	2010-07-21 22:13:36.000000000 +0800
@@ -15 +15 @@
-start on login-prompt-visible
+start on started udev
EOF

if [ -r "${ROOT_FS_DIR}/etc/init/update-engine.conf" ]; then
  patch -d "${ROOT_FS_DIR}" -Np1 <<EOF
diff -Na -U 0 old/etc/init/update-engine.conf new/etc/init/
--- old/etc/init/update-engine.conf	2010-08-05 16:32:55.000000000 -0700
+++ new/etc/init/update-engine.conf	2010-08-05 16:32:45.000000000 -0700
@@ -8 +8 @@
-start on starting system-services and started dbus
+start on never
EOF
fi

if [ -r "${ROOT_FS_DIR}/etc/init/chrontel.conf" ]; then
  patch -d "${ROOT_FS_DIR}" -Np1 <<EOF
diff -Nau old/etc/init/chrontel.conf new/etc/init/
--- old/etc/init/chrontel.conf	2010-08-05 16:32:55.000000000 -0700
+++ new/etc/init/chrontel.conf	2010-08-05 16:32:45.000000000 -0700
@@ -7 +7 @@
-start on started udev
+start on never
EOF
fi

if [ -r "${ROOT_FS_DIR}/etc/init/tegra-devices.conf" ]; then
  patch -d "${ROOT_FS_DIR}" -Np1 <<EOF
diff -Nau old/etc/init/tegra-devices.conf new/etc/init/
--- old/etc/init/tegra-devices.conf	2011-04-08 10:40:01.000000000 -0500
+++ new/etc/init/tegra-devices.conf	2011-04-08 10:40:16.000000000 -0500
@@ -9,7 +9,7 @@ author        "chromium-os-dev@chromium.
 # ui runs, so we won't be racing with X starting. It will be left in
 # "running" state by upstart so it won't re-launch on every ui restart
 
-start on starting ui
+start on starting factory
 
 pre-start script
   for i in nvmap nvos nvrm nvrpc nvfw tegra_avp tegra_sema tegra_rpc ; do
EOF
fi
